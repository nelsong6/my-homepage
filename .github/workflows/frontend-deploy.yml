name: Deploy Frontend

on:
  workflow_dispatch: # Allows manual triggering
  push:
    branches: [ "main" ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-frontend:
    name: Deploy Vanilla JS Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install spacectl
        uses: spacelift-io/setup-spacectl@v1

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.ARM_CLIENT_ID }}
          tenant-id: ${{ vars.ARM_TENANT_ID }}
          subscription-id: ${{ vars.ARM_SUBSCRIPTION_ID }}

      - name: Fetch Spacelift Credentials from Key Vault
        run: |
          set -euo pipefail
          
          RAW_ID=$(az keyvault secret show --vault-name "${{ vars.KEY_VAULT_NAME }}" --name spacelift-api-key-id --query value -o tsv)
          KV_ID=$(echo "$RAW_ID" | tr -d '\r\n')
          echo "::add-mask::$KV_ID"
          echo "SPACELIFT_API_KEY_ID=$KV_ID" >> $GITHUB_ENV

          RAW_SECRET=$(az keyvault secret show --vault-name "${{ vars.KEY_VAULT_NAME }}" --name spacelift-api-key-secret --query value -o tsv)
          KV_SECRET=$(echo "$RAW_SECRET" | tr -d '\r\n')
          echo "::add-mask::$KV_SECRET"
          echo "SPACELIFT_API_KEY_SECRET=$KV_SECRET" >> $GITHUB_ENV

      - name: Fetch Outputs & Generate Config
        env:
          SPACELIFT_API_KEY_ENDPOINT: 'https://nelsong6.app.us.spacelift.io'
        run: |
          set -euo pipefail
          APP_STACK_ID=${GITHUB_REPOSITORY#*/}

          echo "Fetching outputs from infra-bootstrap..."
          INFRA_OUTPUTS=$(spacectl stack outputs --id infra-bootstrap --output json)
          export AUTH0_DOMAIN=$(echo "$INFRA_OUTPUTS" | jq -r '.[] | select(.id == "auth0_domain") | .value | fromjson')
          
          echo "Fetching outputs from app stack: $APP_STACK_ID..."
          APP_OUTPUTS=$(spacectl stack outputs --id "$APP_STACK_ID" --output json)
          export AUTH0_CLIENT_ID=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_client_id") | .value | fromjson')
          export AUTH0_AUDIENCE=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "auth0_audience") | .value | fromjson')
          export API_URL=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "backend_api_url") | .value | fromjson')
          
          # Save Azure variables to environment for the deploy step
          echo "STATIC_WEB_APP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "static_web_app_name") | .value | fromjson')" >> $GITHUB_ENV
          echo "RESOURCE_GROUP_NAME=$(echo "$APP_OUTPUTS" | jq -r '.[] | select(.id == "resource_group_name") | .value | fromjson')" >> $GITHUB_ENV

          echo "Running config generator..."
          chmod +x ./frontend/generate-config.sh
          ./frontend/generate-config.sh

      - name: Get Static Web App Deployment Token
        id: static-web-app-token
        run: |
          DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --query "properties.apiKey" -o tsv)
          echo "::add-mask::$DEPLOYMENT_TOKEN"
          echo "deployment_token=$DEPLOYMENT_TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.static-web-app-token.outputs.deployment_token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "./frontend" # Maps directly to the root of your frontend folder
          output_location: ""        # Purposely blank because there is no dist/ folder
          skip_app_build: true       # Tells Azure not to look for a package.json
